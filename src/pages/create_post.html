<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สร้างโพสต์ใหม่</title>
    <link rel="stylesheet" href="create_post.css">
    <!-- <link rel="stylesheet" href="../../public/post.css"> -->
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="profile">
                <img src="user.png" alt="User Avatar" class="avatar">
                <h2 id="username">User</h2>
            </div>

            <div class="menu">
                <p class="menu-title">หมวดหมู่</p>
                <input type="text" placeholder="ค้นหา" class="search-box">
                <ul class="category-list" id="category-list"></ul>
            </div>

            <button class="new-category-btn">สร้างหมวดหมู่ใหม่</button>
            <button class="sandbox-btn">SandBox</button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="post-box">
                <!-- Header -->
                <div class="post-header">
                    <div class="user-info">
                        <img src="user.png" class="post-avatar" alt="User Avatar">
                        <!-- <img src="../../public/user.png" class="post-avatar" alt="User Avatar"> -->
                        <div>
                            <h3 id="post-username">User</h3>
                            <select class="category-dropdown">
                            </select>
                        </div>
                    </div>
                    <button class="post-btn" onclick="window.location.href='/'">โพสต์</button>
                </div>

                <!-- หัวข้อโพสต์ -->
                <input type="text" class="post-title" placeholder="ใส่หัวข้อโพสต์">

                <!-- เนื้อหาหลัก -->
                <div id="postContent">
                    <textarea class="post-text" placeholder="เขียนสิ่งที่คุณต้องการแชร์..."></textarea>
                </div>

                <!-- ปุ่มเพิ่มเนื้อหา -->
                <div class="actions">
                    <button class="img-btn">แนบรูปภาพ</button>
                    <button class="code-btn">เพิ่มโค้ด</button>
                    <button class="cancel-btn" onclick="window.location.href='homepage.html'">ยกเลิก</button>
                    <input type="file" id="imageInput" accept="image/*" style="display:none">
                </div>
            </div>
        </main>
    </div>

    <!-- Popup modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <h2>สร้างหมวดหมู่ใหม่</h2>
            <input type="text" id="category-name" placeholder="ใส่ชื่อหมวดหมู่ใหม่..." />
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancel-btn">ยกเลิก</button>
                <button class="modal-btn" id="save-btn">บันทึก</button>
            </div>
        </div>
    </div>

    <script>
        // helper to read cookie (non httpOnly)
        function readCookie(name) {
            const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
            return v ? decodeURIComponent(v.pop()) : null;
        }

        // get user from cookie and set username in UI
        let currentUser = null;
        const userCookie = readCookie('user');
        if (userCookie) {
            try { currentUser = JSON.parse(userCookie); } catch (e) { currentUser = null; }
        }
        if (currentUser && currentUser.username) {
            const unameEl = document.getElementById('username');
            const uname = document.getElementById('post-username');
            if (unameEl) unameEl.textContent = currentUser.username;
            if (uname) uname.textContent = currentUser.username;
        }
        const postContent = document.getElementById('postContent');
        const codeBtn = document.querySelector('.code-btn');
        const imgBtn = document.querySelector('.img-btn');
        const imageInput = document.getElementById('imageInput');

        /* ฟังก์ชันสร้าง textarea ใหม่ */
        function createTextArea() {
            const textarea = document.createElement('textarea');
            textarea.classList.add('post-text');
            textarea.placeholder = "เขียนสิ่งที่คุณต้องการแชร์...";
            return textarea;
        }

        // เก็บข้อมูลรูปและโค้ดในตัวแปร
        let uploadedImages = [];
        let codeBlocks = [];

        /* เพิ่ม code block แยก container */
        codeBtn.addEventListener('click', () => {
            const codeData = {
                id: Date.now(),
                code: ''
            };
            codeBlocks.push(codeData);

            const postItem = document.createElement('div');
            postItem.classList.add('post-item');
            postItem.dataset.codeId = codeData.id;

            const codeBlock = document.createElement('div');
            codeBlock.classList.add('code-block');
            codeBlock.innerHTML = `
        <button class="close-btn">&times;</button>
        <div class="code-header">Python</div>
        <textarea class="code-content" placeholder="เขียนโค้ดของคุณที่นี่..."></textarea>
    `;

            codeBlock.querySelector('.close-btn').addEventListener('click', () => {
                codeBlocks = codeBlocks.filter(code => code.id !== codeData.id);
                postItem.remove();
            });

            codeBlock.querySelector('.code-content').addEventListener('input', (e) => {
                const index = codeBlocks.findIndex(code => code.id === codeData.id);
                if (index !== -1) {
                    codeBlocks[index].code = e.target.value;
                }
            });

            postItem.appendChild(codeBlock);

            postContent.appendChild(postItem);
            postItem.scrollIntoView({ behavior: 'smooth' });
        });

        /* แนบรูปภาพแยก container */
        imgBtn.addEventListener('click', () => imageInput.click());

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (event) {
                const imageData = {
                    id: Date.now(), // temp id for frontend
                    data: event.target.result
                };
                uploadedImages.push(imageData);

                const postItem = document.createElement('div');
                postItem.classList.add('post-item');
                postItem.dataset.imageId = imageData.id;

                const wrapper = document.createElement('div');
                wrapper.classList.add('image-wrapper');
                wrapper.innerHTML = `
            <button class="close-btn">&times;</button>
            <img src="${imageData.data}" alt="Preview Image">
        `;

                wrapper.querySelector('.close-btn').addEventListener('click', () => {
                    uploadedImages = uploadedImages.filter(img => img.id !== imageData.id);
                    postItem.remove();
                });

                // กำหนดขนาดรูป
                const img = wrapper.querySelector('img');
                img.style.maxWidth = "100%";
                img.style.maxHeight = "250px";
                img.style.borderRadius = "8px";
                wrapper.style.border = "1px solid #007bff";
                wrapper.style.padding = "8px";
                wrapper.style.marginBottom = "10px";
                wrapper.style.position = "relative";

                postItem.appendChild(wrapper);

                postContent.appendChild(postItem);
                postItem.scrollIntoView({ behavior: 'smooth' });
            };
            reader.readAsDataURL(file);
            imageInput.value = "";
        });

        // Sidebar profile click
        document.querySelector('.sidebar .avatar').addEventListener('click', () => {
            window.location.href = '/profile';
        });


        // เปิด popup
        const modal = document.getElementById("modal-overlay");
        document.querySelector(".new-category-btn").addEventListener("click", () => {
            modal.style.display = "flex";
            document.getElementById("category-name").focus();
        });

        // ปุ่มยกเลิก
        document.getElementById("cancel-btn").addEventListener("click", () => {
            modal.style.display = "none";
            document.getElementById("category-name").value = "";
        });

        // ปุ่มบันทึก
        document.getElementById("save-btn").addEventListener("click", () => {
            const name = document.getElementById("category-name").value.trim();
            if (name) {
                const ul = document.querySelector(".category-list");
                const li = document.createElement("li");
                li.textContent = name;
                ul.appendChild(li);
                document.getElementById("category-name").value = "";
                modal.style.display = "none";
            }
        });
        async function fetchCategories() {
            const res = await fetch('/categories', { credentials: 'include' });
            categories = await res.json();
            renderCategories();
        }

        function renderCategories() {
            const list = document.getElementById('category-list');
            list.innerHTML = '';
            categories.forEach(cat => {
                const li = document.createElement('li');
                li.textContent = cat.name;
                li.addEventListener('click', () => {
                    // เปลี่ยนหน้าไป homepage พร้อมส่ง categoryId เป็น query string
                    window.location.href = `/?categoryId=${encodeURIComponent(cat.id)}`;
                });
                list.appendChild(li);
            });
        }

        // Initial load
        fetchCategories();

        async function loadCategories() {
            const res = await fetch('/categories', { credentials: 'include' });
            const categories = await res.json();

            const dropdown = document.querySelector('.category-dropdown');
            dropdown.innerHTML = categories.map(cat =>
                `<option value="${cat.id}">${cat.name}</option>`
            ).join('');
        }

        // Call on page load
        loadCategories();

        document.querySelector('.post-btn').addEventListener('click', async (e) => {
            e.preventDefault();

            // ตรวจสอบข้อมูลก่อนส่ง
            const formData = {
                title: document.querySelector('.post-title').value.trim(),
                text: document.querySelector('.post-text').value.trim(),
                categoryId: document.querySelector('.category-dropdown').value,
                images: uploadedImages.map(img => img.data).filter(Boolean),
                codes: codeBlocks.map(code => code.code).filter(code => code.trim())
            };

            // Validate required fields
            if (!formData.title || !formData.categoryId) {
                alert('Please fill in all required fields');
                return;
            }

            const res = await fetch('/posts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(formData)
            });

            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.message || 'Failed to create post');
            }

            window.location.href = '/';
        });
    </script>
</body>

</html>