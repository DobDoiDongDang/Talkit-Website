<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สร้างโพสต์ใหม่</title>
    <link rel="stylesheet" href="create_post.css">
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="profile">
                <img src="user.png" alt="User Avatar" class="avatar">
                <h2 id="username">User</h2>
            </div>

            <div class="menu">
                <p class="menu-title">หมวดหมู่</p>
                <ul class="category-list" id="category-list"></ul>
            </div>

            <button class="new-category-btn">สร้างหมวดหมู่ใหม่</button>
            <button class="sandbox-btn">SandBox</button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="post-box">
                <!-- Header -->
                <div class="post-header">
                    <div class="user-info">
                        <img src="user.png" class="post-avatar" alt="User Avatar">
                        <div>
                            <h3 id="post-username">User</h3>
                            <select class="category-dropdown"></select>
                        </div>
                    </div>
                    <button class="post-btn">โพสต์</button>
                </div>

                <!-- หัวข้อโพสต์ -->
                <input type="text" class="post-title" placeholder="ใส่หัวข้อโพสต์">

                <!-- เนื้อหาหลัก -->
                <div id="postContent">
                    <textarea class="post-text" placeholder="เขียนสิ่งที่คุณต้องการแชร์..."></textarea>
                </div>

                <!-- รูปภาพ preview -->
                <div id="image-preview" class="preview-container"></div>

                <!-- โค้ด blocks -->
                <div id="code-blocks" class="code-container"></div>

                <!-- ปุ่มเพิ่มเนื้อหา -->
                <div class="actions">
                    <button class="img-btn">แนบรูปภาพ</button>
                    <button class="code-btn">เพิ่มโค้ด</button>
                    <button class="cancel-btn" onclick="window.location.href='/'">ยกเลิก</button>
                    <input style="display: none;" type="file" id="imageInput" name="images[]" accept="image/*" multiple>
                </div>
            </div>
        </main>
    </div>

    <!-- Image Preview Overlay -->
    <div id="imagePreviewOverlay" class="image-preview-overlay" style="display:none;">
        <div class="image-preview-content">
            <img id="previewedImage" src="" alt="preview">
        </div>
    </div>

    <!-- Popup modal -->
    <div class="modal-overlay" id="modal-overlay" style="display:none;">
        <div class="modal">
            <h2>สร้างหมวดหมู่ใหม่</h2>
            <input type="text" id="category-name" placeholder="ใส่ชื่อหมวดหมู่ใหม่..." />
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancel-btn">ยกเลิก</button>
                <button class="modal-btn" id="save-btn">บันทึก</button>
            </div>
        </div>
    </div>

    <script>
        document.querySelector('.sandbox-btn').addEventListener('click', () => {
            window.location.href = '/sand';
        });

        // helper to read cookie (non httpOnly)
        function readCookie(name) {
            const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
            return v ? decodeURIComponent(v.pop()) : null;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function hydrateSidebarProfile() {
            let user = null;
            const raw = readCookie('user');
            if (raw) { try { user = JSON.parse(raw); } catch { } }
            if (!user || !user.userProfile || !user.username) {
                try {
                    const res = await fetch('/profiles/me', { credentials: 'include' });
                    if (res.ok) user = await res.json();
                } catch { }
            }
            const sidebarAvatar = document.querySelector('.sidebar .avatar');
            const sidebarName = document.querySelector('.sidebar #username');
            const headerAvatar = document.querySelector('.post-header .post-avatar');
            const headerName = document.getElementById('post-username');

            const avatarSrc = (user && user.userProfile) ? user.userProfile : 'user.png';
            if (sidebarAvatar) sidebarAvatar.src = avatarSrc;
            if (headerAvatar) headerAvatar.src = avatarSrc;
            if (sidebarName && user?.username) sidebarName.textContent = user.username;
            if (headerName && user?.username) headerName.textContent = user.username;
        }

        hydrateSidebarProfile();

        // **State Management เหมือน edit_post.html**
        const imageState = {
            new: [] // รูปใหม่ที่เพิ่ม
        };

        const codeState = {
            new: [] // โค้ดใหม่ที่เพิ่ม
        };

        // **Render image previews เหมือน edit_post.html**
        function renderImagePreviews() {
            const preview = document.getElementById('image-preview');
            preview.innerHTML = '';
            
            imageState.new.forEach((file, index) => {
                const url = URL.createObjectURL(file);
                const div = createImagePreview(url, () => {
                    URL.revokeObjectURL(url);
                    imageState.new.splice(index, 1);
                    renderImagePreviews();
                }, `new-${index}`);
                
                preview.appendChild(div);
            });
        }

        // **Helper function สำหรับสร้าง image preview เหมือน edit_post.html**
        function createImagePreview(src, onDelete, debugId) {
            const div = document.createElement('div');
            div.className = 'image-wrapper'; // ใช้ class จาก CSS แทน inline style
            div.setAttribute('data-debug-id', debugId);
            
            const imgEl = document.createElement('img');
            imgEl.src = src;
            imgEl.className = 'clickable-image'; // ใช้ class สำหรับ hover effect
            imgEl.title = 'คลิกเพื่อขยาง';
            
            imgEl.addEventListener('click', () => {
                const overlay = document.getElementById('imagePreviewOverlay');
                const previewImg = document.getElementById('previewedImage');
                previewImg.src = src;
                overlay.style.display = 'flex';
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '×';
            deleteBtn.className = 'close-btn'; // ใช้ class จาก CSS
            
            deleteBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                onDelete();
            });
            
            div.appendChild(imgEl);
            div.appendChild(deleteBtn);
            return div;
        }

        // **Render code blocks เหมือน edit_post.html**
        function renderCodeBlocks() {
            const container = document.getElementById('code-blocks');
            container.innerHTML = '';
            
            codeState.new.forEach((code, index) => {
                const blockEl = createCodeBlock(
                    code,
                    `Code ${index + 1}`,
                    (newCode) => {
                        codeState.new[index] = newCode;
                    },
                    () => {
                        codeState.new.splice(index, 1);
                        renderCodeBlocks();
                    },
                    `new-${index}`
                );
                
                container.appendChild(blockEl);
            });
        }

        // **Helper function สำหรับสร้าง code block เหมือน edit_post.html**
        function createCodeBlock(initialCode, title, onUpdate, onDelete, debugId) {
            const wrap = document.createElement('div');
            wrap.className = 'code-block';
            wrap.style.marginBottom = '15px';
            wrap.style.border = '1px solid #ddd';
            wrap.style.borderRadius = '8px';
            wrap.style.padding = '10px';
            wrap.style.backgroundColor = '#f8f9fa';
            wrap.setAttribute('data-debug-id', debugId);
            
            wrap.innerHTML = `
                <button class="close-btn" type="button" style="float: right; background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">&times;</button>
                <div class="code-header" style="margin-bottom: 10px; clear: both;">
                    <span style="font-weight: bold;">${title}</span>
                </div>
                <div class="code-content-wrapper">
                    <div class="code-content-container" style="display: flex; border: 1px solid #ccc; border-radius: 4px;">
                        <div class="line-numbers" style="background: #f1f3f4; padding: 8px 4px; font-family: monospace; font-size: 12px; line-height: 1.5; min-width: 30px; text-align: right; color: #666; border-right: 1px solid #ccc;">1</div>
                        <textarea class="code-content" placeholder="# เขียนโค้ด Python ของคุณที่นี่..." rows="6" style="flex: 1; border: none; padding: 8px; font-family: monospace; font-size: 14px; line-height: 1.5; resize: vertical; outline: none;">${escapeHtml(initialCode || '')}</textarea>
                    </div>
                </div>
                <div class="code-footer" style="margin-top: 10px;">
                    <div class="code-output" style="display:none; background: #f8f9fa; border: 1px solid #ddd; padding: 10px; margin-top: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace;"></div>
                    <button class="run-btn" type="button" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Run Code</button>
                </div>
            `;

            const ta = wrap.querySelector('.code-content');
            const closeBtn = wrap.querySelector('.close-btn');
            const runBtn = wrap.querySelector('.run-btn');
            const outputDiv = wrap.querySelector('.code-output');
            const lineNumbersDiv = wrap.querySelector('.line-numbers');

            function updateLineNumbers() {
                const text = ta.value || '';
                const lines = text.split('\n');
                const lineCount = lines.length;
                
                const lineNumbers = Array.from({length: lineCount}, (_, i) => (i + 1).toString()).join('\n');
                lineNumbersDiv.textContent = lineNumbers;
                
                ta.style.height = 'auto';
                ta.style.height = Math.max(80, ta.scrollHeight) + 'px';
            }

            ta.addEventListener('input', () => {
                onUpdate(ta.value);
                updateLineNumbers();
            });

            ta.addEventListener('scroll', () => {
                lineNumbersDiv.scrollTop = ta.scrollTop;
            });

            closeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                onDelete();
            });

            runBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const code = ta.value.trim();
                if (!code) {
                    alert('กรุณาเขียนโค้ดก่อนรัน');
                    return;
                }

                runBtn.disabled = true;
                runBtn.textContent = 'Running...';
                outputDiv.style.display = 'block';
                outputDiv.textContent = 'Executing code...';

                try {
                    const response = await fetch('/sand/run', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code }),
                        credentials: 'include'
                    });

                    const result = await response.json();
                    outputDiv.textContent = result.result;
                } catch (error) {
                    outputDiv.textContent = `Network Error: ${error.message}`;
                } finally {
                    runBtn.disabled = false;
                    runBtn.textContent = 'Run Code';
                }
            });

            updateLineNumbers();
            return wrap;
        }

        // **Add code block function**
        function addCodeBlock() {
            codeState.new.push('');
            renderCodeBlocks();
            
            // Focus ไปที่ textarea ใหม่
            setTimeout(() => {
                const newBlocks = document.querySelectorAll('[data-debug-id^="new-"]');
                if (newBlocks.length > 0) {
                    const lastBlock = newBlocks[newBlocks.length - 1];
                    const textarea = lastBlock.querySelector('.code-content');
                    if (textarea) textarea.focus();
                }
            }, 100);
        }

        // **Setup image preview overlay**
        function setupImagePreview() {
            const overlay = document.getElementById('imagePreviewOverlay');
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.style.display = 'none';
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && overlay.style.display === 'flex') {
                    overlay.style.display = 'none';
                }
            });
        }

        // **Event Listeners - แก้ไขให้ใช้ state management**
        const codeBtn = document.querySelector('.code-btn');
        const imgBtn = document.querySelector('.img-btn');
        const imageInput = document.getElementById('imageInput');

        // เพิ่มโค้ด - ใช้ฟังก์ชันใหม่
        codeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            addCodeBlock();
        });

        // แนบรูปภาพ - ใช้ state management
        imgBtn.addEventListener('click', () => imageInput.click());

        imageInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                imageState.new.push(...files);
                renderImagePreviews();
                e.target.value = ''; // Clear input
            }
        });

        // Sidebar profile click
        document.querySelector('.sidebar .avatar').addEventListener('click', () => {
            window.location.href = '/profile';
        });

        // เปิด popup
        const modal = document.getElementById("modal-overlay");
        document.querySelector(".new-category-btn").addEventListener("click", () => {
            modal.style.display = "flex";
            document.getElementById("category-name").focus();
        });

        // ปุ่มยกเลิก
        document.getElementById("cancel-btn").addEventListener("click", () => {
            modal.style.display = "none";
            document.getElementById("category-name").value = "";
        });

        // ปุ่มบันทึก
        document.getElementById("save-btn").addEventListener("click", async () => {
            const name = document.getElementById("category-name").value.trim();
            if (!name) return;
            // เพิ่มหมวดหมู่ใหม่ลง backend
            const res = await fetch('/categories', {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            if (res.ok) {
                await fetchCategories();
            }
            document.getElementById("category-name").value = "";
            modal.style.display = "none";
        });

        let categories = [];
        async function fetchCategories() {
            const res = await fetch('/categories', { credentials: 'include' });
            categories = await res.json();
            renderCategories();
        }

        function renderCategories() {
            const list = document.getElementById('category-list');
            list.innerHTML = '';
            categories.forEach(cat => {
                const li = document.createElement('li');
                li.textContent = cat.name;
                li.addEventListener('click', () => {
                    window.location.href = `/?categoryId=${encodeURIComponent(cat.id)}`;
                });
                list.appendChild(li);
            });
        }

        // Initial load
        fetchCategories();

        async function loadCategories() {
            const res = await fetch('/categories', { credentials: 'include' });
            const categories = await res.json();

            const dropdown = document.querySelector('.category-dropdown');
            dropdown.innerHTML = categories.map(cat =>
                `<option value="${cat.id}">${cat.name}</option>`
            ).join('');
        }

        // Call on page load
        loadCategories();

        // **แก้ไขการส่งข้อมูล - ใช้ state management**
        document.querySelector('.post-btn').addEventListener('click', async (e) => {
            e.preventDefault();

            const title = document.querySelector('.post-title').value.trim();
            const text = document.querySelector('.post-text').value.trim();
            const categoryId = document.querySelector('.category-dropdown').value;

            if (!title || !categoryId) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            const formData = new FormData();
            formData.append("title", title);
            formData.append("text", text);
            formData.append("categoryId", categoryId);

            // ส่งโค้ดจาก state
            const codes = codeState.new.filter(code => code && code.trim());
            codes.forEach(code => formData.append("codes", code));

            // ส่งรูปภาพจาก state
            imageState.new.forEach(file => {
                formData.append("images", file);
            });

            console.log('Sending to backend:', {
                title,
                text,
                categoryId,
                codes: codes.length,
                images: imageState.new.length
            });

            const res = await fetch('/posts', {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });

            if (!res.ok) {
                const error = await res.json();
                alert(error.message || 'Failed to create post');
                return;
            }

            const result = await res.json();
            console.log('Post created successfully:', result);
            window.location.href = '/';
        });

        // Initialize
        setupImagePreview();
    </script>
</body>

</html>