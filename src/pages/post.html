<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ดูโพสต์ทั้งหมด</title>
  <link rel="stylesheet" href="post.css">
  <style>
    /* Small red report button used for posts and comments */
    .report-btn {
      background-color: #ef4444; /* red-500 */
      color: white;
      border: none;
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.12s;
      display: inline-block;
      line-height: 1;
    }
    .report-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.12);
      opacity: 0.95;
    }
    .report-btn:active {
      transform: translateY(0);
    }
    /* Report modal styles */
    .report-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.45);
      z-index: 1200;
      padding: 24px;
      animation: fadeIn 160ms ease;
    }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    .report-modal {
      background: #fff;
      border-radius: 12px;
      width: 100%;
      max-width: 640px;
      box-shadow: 0 12px 40px rgba(2,6,23,0.2);
      padding: 18px 20px;
      position: relative;
    }
    .report-modal h3 { margin: 0 0 8px 0; font-size: 18px; }
    .report-modal label { display:block; font-size:13px; color:#333; margin-bottom:6px }
    .report-modal textarea { width:100%; min-height:120px; resize:vertical; padding:10px; border-radius:8px; border:1px solid #e5e7eb; font-size:14px }
    .report-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px }
    .report-actions .submit-btn { background:#ef4444; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer }
    .report-actions .cancel-btn { background:#f3f4f6; color:#111827; border:none; padding:8px 12px; border-radius:8px; cursor:pointer }
    .report-close { position:absolute; right:10px; top:8px; background:transparent; border:none; font-size:20px; line-height:1; cursor:pointer; color:#6b7280 }
    .report-close:hover { color:#111827 }
  </style>
</head>

<body>
  <div class="container">
    <!-- Sidebar (เหมือน homepage) -->
    <aside class="sidebar">
      <div class="profile">
        <img src="user.png" alt="User Avatar" class="avatar">
        <h2 id="username">User</h2>
      </div>
      <div class="menu">
        <p class="menu-title">หมวดหมู่</p>
        <ul class="category-list" id="category-list"></ul>
      </div>
      <button class="new-category-btn">สร้างหมวดหมู่ใหม่</button>
      <button class="sandbox-btn">SandBox</button>
    </aside>

    <!-- Main content -->
    <main class="main-content">
      <div class="post-box" id="post-box">
        <!-- ข้อมูลโพสต์จะถูกเติมด้วย JS -->
      </div>
    </main>
  </div>

  <!-- Popup modal -->
  <div class="modal-overlay" id="modal-overlay" style="display:none;">
    <div class="modal">
      <h2>สร้างหมวดหมู่ใหม่</h2>
      <input type="text" id="category-name" placeholder="กรอกชื่อหมวดหมู่...">
      <div class="modal-actions">
        <button class="modal-btn cancel" id="cancel-btn">ยกเลิก</button>
        <button class="modal-btn" id="save-btn">บันทึก</button>
      </div>
    </div>
  </div>

  <div id="imagePreviewOverlay" class="image-preview-overlay" style="display:none;">
    <div class="image-preview-content">
      <img id="previewedImage" src="" alt="preview">
    </div>
  </div>

  <div class="report-overlay" id="report-overlay" style="display:none;">
    <div class="report-modal" role="dialog" aria-modal="true" aria-labelledby="report-title">
      <button class="report-close" aria-label="ปิด">×</button>
      <h3 id="report-title">รายงานโพสต์ / ความคิดเห็น</h3>
      <p style="margin:6px 0 12px 0; color:#374151; font-size:14px">กรุณาใส่คำอธิบายสั้น ๆ เพื่อให้ผู้ดูแลระบบพิจารณา</p>
      <label for="report-reason">รายละเอียด</label>
      <textarea id="report-reason" placeholder="กรอกเหตุผล..."></textarea>
      <div class="report-actions">
        <button id="report-cancel" class="cancel-btn">ยกเลิก</button>
        <button id="report-submit" class="submit-btn">ส่งรายงาน</button>
      </div>
    </div>
  </div>

  <script>
    document.querySelector('.sandbox-btn').addEventListener('click', () => {
      window.location.href = '/sand';
    });

    function readCookie(name) {
      const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return v ? decodeURIComponent(v.pop()) : null;
    }

    async function hydrateSidebarProfile() {
      let user = null;
      const raw = readCookie('user');
      if (raw) { try { user = JSON.parse(raw); } catch { } }
      if (!user || !user.userProfile || !user.username) {
        try {
          const res = await fetch('/profiles/me', { credentials: 'include' });
          if (res.ok) user = await res.json();
        } catch { }
      }
      const avatarEl = document.querySelector('.sidebar .avatar');
      const nameEl = document.querySelector('.sidebar #username');
      if (avatarEl) avatarEl.src = (user && user.userProfile) ? user.userProfile : 'user.png';
      if (nameEl && user?.username) nameEl.textContent = user.username;
    }

    hydrateSidebarProfile();

    // get user from cookie and set username in UI
    let currentUser = null;
    const userCookie = readCookie('user');
    if (userCookie) { try { currentUser = JSON.parse(userCookie); } catch { currentUser = null; } }
    if (currentUser && currentUser.username) {
      const unameEl = document.getElementById('username');
      if (unameEl) unameEl.textContent = currentUser.username;
    }
    const sidebarAvatar = document.querySelector('.sidebar .avatar');
    if (sidebarAvatar) sidebarAvatar.src = (currentUser && currentUser.userProfile) ? currentUser.userProfile : 'user.png';

    let categories = [];
    let selectedCategory = null;

    async function fetchCategories() {
      const res = await fetch('/categories', { credentials: 'include' });
      categories = await res.json();
      renderCategories();
    }

    function renderCategories() {
      const list = document.getElementById('category-list');
      list.innerHTML = '';
      categories.forEach(cat => {
        const li = document.createElement('li');
        li.textContent = cat.name;
        li.addEventListener('click', () => {
          window.location.href = `/?categoryId=${cat.id}`;
        });
        list.appendChild(li);
      });
    }

    // Sidebar profile click
    document.querySelector('.sidebar .avatar').addEventListener('click', () => {
      window.location.href = '/profile';
    });

    // Popup logic
    const modalOverlay = document.getElementById('modal-overlay');
    const cancelBtn = document.getElementById('cancel-btn');
    const saveBtn = document.getElementById('save-btn');
    const input = document.getElementById('category-name');

    document.querySelector('.new-category-btn').addEventListener('click', () => {
      modalOverlay.style.display = 'flex';
      input.value = '';
      input.focus();
    });

    cancelBtn.onclick = () => modalOverlay.style.display = 'none';

    saveBtn.onclick = async () => {
      const name = input.value.trim();
      if (!name) return alert('กรุณากรอกชื่อหมวดหมู่');
      await fetch('/categories', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      });
      modalOverlay.style.display = 'none';
      fetchCategories();
    };

    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) modalOverlay.style.display = 'none';
    });

    // ดึง postId จาก URL (เช่น /post.html?id=123)
    function getPostId() {
      const params = new URLSearchParams(window.location.search);
      return parseInt(params.get('id')) || null;
    }

    // escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function fetchPostDetail(postId) {
      const res = await fetch(`/posts/${postId}`, { credentials: 'include' });
      if (!res.ok) return null;
      return await res.json();
    }

    // เพิ่มฟังก์ชัน fetchComments ที่หายไป
    async function fetchComments(postId) {
      try {
        const res = await fetch(`/posts/${postId}/comments`, { credentials: 'include' });
        return res.ok ? await res.json() : [];
      } catch (error) {
        console.error('Error fetching comments:', error);
        return [];
      }
    }

    // แก้ไขฟังก์ชัน addLineNumbers ให้ถูกต้อง
    function addLineNumbers(codeText) {
      if (!codeText) return '1';
      const lines = codeText.split('\n');
      const maxDigits = lines.length.toString().length;
      return lines.map((_, index) =>
        (index + 1).toString().padStart(maxDigits, ' ')
      ).join('\n');
    }

    // แก้ไข syntax highlighting ให้ไม่ทำลาย HTML structure
    function highlightSyntax(code) {
      if (!code) return '';

      return code
        // Escape HTML ก่อน
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        // ตัว highlighting
        .replace(/\b(def|class|if|else|elif|for|while|import|from|return|try|except|finally|with|as|lambda|yield|global|nonlocal|assert|break|continue|pass|raise|del|and|or|not|in|is|True|False|None)\b/g, '<span class="syntax-keyword">$1</span>')
        .replace(/(["'])((?:\\.|(?!\1)[^\\])*?)\1/g, '<span class="syntax-string">$1$2$1</span>')
        .replace(/(#.*$)/gm, '<span class="syntax-comment">$1</span>')
        .replace(/\b(\d+\.?\d*)\b/g, '<span class="syntax-number">$1</span>')
        .replace(/\b([a-zA-Z_][a-zA-Z0-9_]*)\s*(?=\()/g, '<span class="syntax-function">$1</span>');
    }

    // helper for safe base64 encoding/decoding
    function b64EncodeUnicode(str) {
      try {
        return btoa(encodeURIComponent(str));
      } catch (e) {
        console.error('Base64 encode error:', e);
        return btoa(str); // fallback
      }
    }

    function b64DecodeUnicode(b64) {
      try {
        return decodeURIComponent(atob(b64));
      } catch (e) {
        console.error('Base64 decode error:', e);
        try {
          return atob(b64); // fallback
        } catch (e2) {
          console.error('Base64 fallback decode error:', e2);
          return ''; // last resort
        }
      }
    }

    // แก้ไขฟังก์ชัน renderPostDetail ให้ใช้ JSON.stringify แทน base64
    function renderPostDetail(data, comments) {
      if (!data) {
        document.getElementById('post-box').innerHTML = '<p>ไม่พบโพสต์นี้</p>';
        return;
      }
      const { post, codes, pictures } = data;
      let html = `
        <div class="post-header">
          <div class="user-info">
            <img src="${escapeHtml(post.userProfile || 'user.png')}" class="post-avatar" alt="User Avatar" />
            <div><h3>${escapeHtml(post.username || 'Anon')}</h3></div>
            <button class="report-btn" onclick='openReportPopup("post")'>รายงาน</button>
          </div>
        </div>
        <h4 class="post-title">${escapeHtml(post.title)}</h4>
        <p>${escapeHtml(post.text)}</p>
      `;

      if (pictures && pictures.length) {
        html += `<div class="post-pictures">` +
          pictures.map(pic => `
            <img src="${escapeHtml(pic.url || pic.data)}" 
                 class="post-img clickable-image" 
                 alt="post image" 
                 title="คลิกเพื่อขยาย" />
          `).join('') +
          `</div>`;
      }

      // เก็บ codes ใน global variable แทนการใส่ใน attribute
      if (codes && codes.length) {
        window.postCodes = codes; // เก็บไว้ใน global
        codes.forEach((code, index) => {
          const codeText = code.code || '';
          const lineNumbers = addLineNumbers(codeText);
          const highlightedCode = highlightSyntax(codeText);
          const lineCount = codeText.split('\n').length;

          html += `
          <div class="code-block" data-code-index="${index}">
            <div class="code-header">
              <span>Python Code</span>
              <span>${lineCount} lines</span>
            </div>
            <div class="code-content-wrapper">
              <div class="line-numbers">${lineNumbers}</div>
              <pre class="code-content">${highlightedCode}</pre>
            </div>
            <div class="code-footer">
              <div class="code-output" style="display:none;"></div>
              <button class="run-btn" onclick="runPostCode(${index})">Run Code</button>
            </div>
          </div>`;
        });
      }

      html += `
        <hr />
        <div class="comment-section">
          <h4>แสดงความคิดเห็น</h4>
          <textarea class="comment-input" placeholder="พิมพ์ความคิดเห็นของคุณ..."></textarea>
          <div class="comment-actions" style="display:flex; gap:8px; margin-top:8px;">
            <button class="img-btn" type="button">แนบรูปภาพ</button>
            <button class="code-btn" type="button">เพิ่มโค้ด</button>
            <button class="submit-comment" type="button">เพิ่มความคิดเห็น</button>
          </div>
          <input type="file" id="commentImageInput" accept="image/*" multiple style="display:none">
          <div id="comment-image-preview" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;"></div>
          <div id="comment-code-list" style="display:flex; flex-direction:column; gap:8px; margin-top:8px;"></div>
        </div>
        <hr />
        <div class="all-comments">
      `;

      // เก็บ comment codes ใน global variable
      window.commentCodes = {};

      if (comments && comments.length) {
        comments.forEach(comment => {
          html += `
          <div class="single-comment">
            <img src="${escapeHtml(comment.userProfile || 'user.png')}" class="comment-avatar" alt="" />
            <div class="comment-content">
              <h5>${escapeHtml(comment.username || 'Anon')}</h5>
              <p>${escapeHtml(comment.text)}</p>
              <button class="report-btn" onclick='openReportPopup("comment", ${comment.id})'>รายงาน</button>
          `;

          if (comment.pictures && comment.pictures.length) {
            html += `<div class="comment-pictures">` +
              comment.pictures.map(pic => `
                <img src="${escapeHtml(pic.url || pic.data)}" 
                     class="comment-img clickable-image" 
                     alt="comment image" 
                     title="คลิกเพื่อขยาย" />
              `).join('') +
              `</div>`;
          }

          if (comment.codes && comment.codes.length) {
            comment.codes.forEach((code, codeIndex) => {
              const uniqueId = `comment-${comment.id}-code-${codeIndex}`;
              const codeText = code.code || '';
              const lineNumbers = addLineNumbers(codeText);
              const highlightedCode = highlightSyntax(codeText);
              const lineCount = codeText.split('\n').length;

              // เก็บโค้ดใน global object
              window.commentCodes[uniqueId] = codeText;

              html += `
              <div class="code-block small-code" data-comment-code-id="${uniqueId}">
                <div class="code-header">
                  <span>Python Code</span>
                  <span>${lineCount} lines</span>
                </div>
                <div class="code-content-wrapper">
                  <div class="line-numbers">${lineNumbers}</div>
                  <pre class="code-content">${highlightedCode}</pre>
                </div>
                <div class="code-footer">
                  <div class="code-output" style="display:none;"></div>
                  <button class="run-btn" onclick="runCommentCode('${uniqueId}')">Run Code</button>
                </div>
              </div>`;
            });
          }
          html += `
          </div>
        </div>`;
        });
      } else {
        html += `<p>ยังไม่มีความคิดเห็น</p>`;
      }
      html += `</div>`;

      document.getElementById('post-box').innerHTML = html;
      setupCommentComposer(post.id);
      setupImagePreview(); // เรียกใช้หลังจากเติม HTML เสร็จ
    }

    // แก้ไขฟังก์ชันรันโค้ด
    window.runPostCode = async function (codeIndex) {
      console.log('Running post code:', codeIndex);

      if (!window.postCodes || !window.postCodes[codeIndex]) {
        alert('ไม่พบโค้ดที่ต้องการรัน');
        return;
      }

      const codeBlock = document.querySelector(`[data-code-index="${codeIndex}"]`);
      if (!codeBlock) {
        alert('ไม่พบ element โค้ด');
        return;
      }

      const runBtn = codeBlock.querySelector('.run-btn');
      const outputDiv = codeBlock.querySelector('.code-output');
      const code = window.postCodes[codeIndex].code || '';

      console.log('Code to run:', code);

      runBtn.disabled = true;
      runBtn.textContent = 'Running...';
      outputDiv.style.display = 'block';
      outputDiv.textContent = 'Executing code...';
      outputDiv.className = 'code-output';

      try {
        const response = await fetch('/sand/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: code.trim() }),
          credentials: 'include'
        });

        console.log('Response status:', response.status);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        console.log('Response result:', result);

        outputDiv.textContent = result.result;
        outputDiv.className = 'code-output success';
      } catch (error) {
        console.error('Run code error:', error);
        outputDiv.textContent = `Network Error: ${error.message}`;
        outputDiv.className = 'code-output error';
      } finally {
        runBtn.disabled = false;
        runBtn.textContent = 'Run Code';
      }
    };

    // ลบฟังก์ชัน runCommentCode ที่ซ้ำและเก็บแค่อันเดียว
    window.runCommentCode = async function (uniqueId) {
      console.log('Running comment code:', uniqueId);

      if (!window.commentCodes || !window.commentCodes[uniqueId]) {
        alert('ไม่พบโค้ดที่ต้องการรัน');
        return;
      }

      const codeBlock = document.querySelector(`[data-comment-code-id="${uniqueId}"]`);
      if (!codeBlock) {
        alert('ไม่พบ element โค้ด');
        return;
      }

      const runBtn = codeBlock.querySelector('.run-btn');
      const outputDiv = codeBlock.querySelector('.code-output');
      const code = window.commentCodes[uniqueId];

      console.log('Code to run:', code);

      runBtn.disabled = true;
      runBtn.textContent = 'Running...';
      outputDiv.style.display = 'block';
      outputDiv.textContent = 'Executing code...';
      outputDiv.className = 'code-output';

      try {
        const response = await fetch('/sand/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: code.trim() }),
          credentials: 'include'
        });

        console.log('Response status:', response.status);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        console.log('Response result:', result);

        outputDiv.textContent = result.result;
        outputDiv.className = 'code-output success';
      } catch (error) {
        console.error('Run comment code error:', error);
        outputDiv.textContent = `Network Error: ${error.message}`;
        outputDiv.className = 'code-output error';
      } finally {
        runBtn.disabled = false;
        runBtn.textContent = 'Run Code';
      }
    };

    // แก้ไขฟังก์ชัน setupCommentComposer
    function setupCommentComposer(postId) {
      const section = document.querySelector('.comment-section');
      if (!section) return;

      const imgBtn = section.querySelector('.img-btn');
      const codeBtn = section.querySelector('.code-btn');
      const submitBtn = section.querySelector('.submit-comment');
      const imgInput = section.querySelector('#commentImageInput');
      const preview = section.querySelector('#comment-image-preview');
      const codeList = section.querySelector('#comment-code-list');

      let files = [];
      let codes = [];

      if (imgBtn) {
        imgBtn.onclick = () => imgInput && imgInput.click();
      }

      if (imgInput) {
        imgInput.onchange = () => {
          const selected = Array.from(imgInput.files || []);
          files.push(...selected);
          imgInput.value = '';
          renderPreviews();
        };
      }

      if (codeBtn) {
        codeBtn.onclick = () => {
          const wrap = document.createElement('div');
          wrap.className = 'code-block';
          const uniqueCommentId = `new-comment-code-${Date.now()}`;
          wrap.setAttribute('data-new-comment-code-id', uniqueCommentId);

          wrap.innerHTML = `
            <button class="close-btn" type="button">&times;</button>
            <div class="code-header">
              <span>Python Code</span>
            </div>
            <div class="code-content-wrapper">
              <div class="code-content-container">
                <textarea class="code-content comment-textarea" placeholder="# เขียนโค้ด Python ของคุณที่นี่...\nprint('Hello, World!')" rows="4"></textarea>
              </div>
            </div>
            <div class="code-footer">
              <div class="code-output" style="display:none;"></div>
              <button class="run-btn" type="button">Run Code</button>
            </div>
          `;

          const ta = wrap.querySelector('.code-content');
          const closeBtn = wrap.querySelector('.close-btn');
          const runBtn = wrap.querySelector('.run-btn');
          const outputDiv = wrap.querySelector('.code-output');

          codes.push('');
          const syncIndex = () => Array.from(codeList.children).indexOf(wrap);

          function autoResize() {
            ta.style.height = 'auto';
            ta.style.height = Math.max(80, ta.scrollHeight) + 'px';
          }

          ta.addEventListener('input', () => {
            const idx = syncIndex();
            if (idx > -1) codes[idx] = ta.value;
            autoResize();
          });

          closeBtn.addEventListener('click', () => {
            const idx = syncIndex();
            if (idx > -1) codes.splice(idx, 1);
            wrap.remove();
          });

          runBtn.addEventListener('click', async () => {
            const code = ta.value.trim();
            if (!code) {
              alert('กรุณาเขียนโค้ดก่อนรัน');
              return;
            }

            runBtn.disabled = true;
            runBtn.textContent = 'Running...';
            outputDiv.style.display = 'block';
            outputDiv.textContent = 'Executing code...';
            outputDiv.className = 'code-output';

            try {
              const response = await fetch('/sand/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code }),
                credentials: 'include'
              });

              const result = await response.json();
              outputDiv.textContent = result.result;
              outputDiv.className = 'code-output success';
            } catch (error) {
              outputDiv.textContent = `Network Error: ${error.message}`;
              outputDiv.className = 'code-output error';
            } finally {
              runBtn.disabled = false;
              runBtn.textContent = 'Run Code';
            }
          });

          codeList.appendChild(wrap);
          ta.focus();
          autoResize();
        };
      }

      function renderPreviews() {
        if (!preview) return;
        preview.innerHTML = '';
        files.forEach((f, idx) => {
          const url = URL.createObjectURL(f);
          const box = document.createElement('div');
          box.style.position = 'relative';
          box.style.display = 'inline-block';

          const img = document.createElement('img');
          img.src = url;
          img.style.maxWidth = '120px';
          img.style.maxHeight = '120px';
          img.style.objectFit = 'cover';
          img.style.border = '1px solid #ddd';
          img.style.borderRadius = '8px';
          img.style.cursor = 'pointer';
          img.title = 'คลิกเพื่อขยาย';

          // เพิ่ม event สำหรับขยายรูปพรีวิว
          img.addEventListener('click', () => {
            const overlay = document.getElementById('imagePreviewOverlay');
            const previewImg = document.getElementById('previewedImage');
            previewImg.src = url;
            overlay.style.display = 'flex';
          });

          const del = document.createElement('button');
          del.textContent = '×';
          del.style.position = 'absolute';
          del.style.top = '2px';
          del.style.right = '2px';
          del.style.background = '#ff4d4d';
          del.style.color = '#fff';
          del.style.border = 'none';
          del.style.borderRadius = '50%';
          del.style.width = '20px';
          del.style.height = '20px';
          del.style.cursor = 'pointer';
          del.style.fontSize = '12px';
          del.style.display = 'flex';
          del.style.alignItems = 'center';
          del.style.justifyContent = 'center';
          del.onclick = (e) => {
            e.stopPropagation();
            URL.revokeObjectURL(url); // ล้าง memory
            files.splice(idx, 1);
            renderPreviews();
          };

          box.appendChild(img);
          box.appendChild(del);
          preview.appendChild(box);
        });
      }

      if (submitBtn) {
        submitBtn.onclick = async () => {
          const textArea = section.querySelector('.comment-input');
          const text = textArea ? textArea.value.trim() : '';

          if (!text && codes.filter(Boolean).length === 0 && files.length === 0) {
            alert('กรุณาใส่เนื้อหาความคิดเห็น');
            return;
          }

          const fd = new FormData();
          fd.append('postId', String(postId));
          fd.append('text', text);
          codes.filter(Boolean).forEach(code => fd.append('codes[]', code));
          files.forEach(f => fd.append('images[]', f));

          try {
            const res = await fetch('/posts/comments', {
              method: 'POST',
              body: fd,
              credentials: 'include'
            });

            if (!res.ok) {
              const e = await res.json().catch(() => ({}));
              alert(e.error || 'เพิ่มความคิดเห็นไม่สำเร็จ');
              return;
            }

            // เคลียร์ฟอร์มและโหลดข้อมูลใหม่
            if (textArea) textArea.value = '';
            files = [];
            codes = [];
            renderPreviews();
            codeList.innerHTML = '';

            const [data, cmts] = await Promise.all([fetchPostDetail(postId), fetchComments(postId)]);
            currentPostData = data;
            renderPostDetail(data, cmts);

          } catch (error) {
            alert('เกิดข้อผิดพลาดในการส่งความคิดเห็น');
            console.error('Comment submission error:', error);
          }
        };
      }
    }

    // ฟังก์ชันขยายรูป - แก้ไขให้มีปุ่มปิดที่ใช้งานได้
    function setupImagePreview() {
      const overlay = document.getElementById('imagePreviewOverlay');
      const previewImg = document.getElementById('previewedImage');

      // เพิ่ม event listener ให้รูปทั้งหมดในโพสต์และคอมเมนต์
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('post-img') ||
          e.target.classList.contains('comment-img')) {
          e.preventDefault();
          previewImg.src = e.target.src;
          overlay.style.display = 'flex';
        }
      });

      // ปิดรูปขยายเมื่อคลิกที่พื้นหลัง
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.style.display = 'none';
        }
      });

      // เพิ่ม event listener สำหรับปุ่มปิด (ที่มี CSS ::after)
      const imageContent = overlay.querySelector('.image-preview-content');
      if (imageContent) {
        imageContent.addEventListener('click', (e) => {
          // ตรวจสอบว่าคลิกที่ปุ่มปิด (บริเวณมุมขวาบน)
          const rect = imageContent.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          // ถ้าคลิกใกล้มุมขวาบน (บริเวณที่มีปุ่ม X)
          if (x > rect.width - 60 && y < 60) {
            overlay.style.display = 'none';
          }
        });
      }

      // ปิดรูปขยายเมื่อกด ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && overlay.style.display === 'flex') {
          overlay.style.display = 'none';
        }
      });
    }

    // ฟังก์ชันเพิ่มปุ่ม ⋮ + เมนู
    function addOptionsButton(targetElement, isComment = false) {
      const wrapper = document.createElement('div');
      wrapper.className = 'options-wrapper';

      const btn = document.createElement('button');
      btn.className = 'options-btn';
      btn.textContent = '...';

      const menu = document.createElement('div');
      menu.className = 'options-menu';
      menu.innerHTML = `
    <button class="change-btn">change</button>
    <button class="delete-btn">delete</button>
    <button class="report-btn">report</button>
  `;

      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
      });

      document.addEventListener('click', () => {
        menu.style.display = 'none';
      });

      menu.querySelector('.report-btn').addEventListener('click', () => {
        openReportPopup(isComment ? 'comment' : 'post');
      });

      wrapper.appendChild(btn);
      wrapper.appendChild(menu);
      targetElement.appendChild(wrapper);
    }

    async function openReportPopup(type, id = null) {
      const overlay = document.getElementById('report-overlay');
      const modal = overlay.querySelector('.report-modal');
      const closeBtn = modal.querySelector('.report-close');
      const cancelBtn = document.getElementById('report-cancel');
      const submitBtn = document.getElementById('report-submit');
      const reason = document.getElementById('report-reason');

      // ดึง ID จากระบบ (แล้วแต่คุณจะใช้ post หรือ comment)
      const targetId = type == "post" ? getPostId() : id; // สมมติใช้ฟังก์ชันนี้ดึง ID
      reason.value = '';
      overlay.style.display = 'flex';

      // focus the textarea for accessibility
      setTimeout(() => { try { reason.focus(); } catch {} }, 50);

      const close = () => {
        overlay.style.display = 'none';
        // cleanup listeners
        closeBtn.removeEventListener('click', close);
        overlay.removeEventListener('click', onOverlayClick);
        document.removeEventListener('keydown', onKeyDown);
        cancelBtn.onclick = null;
        submitBtn.onclick = null;
      };

      cancelBtn.onclick = () => close();

      const onOverlayClick = (e) => { if (e.target === overlay) close(); };
      overlay.addEventListener('click', onOverlayClick);

      const onKeyDown = (e) => { if (e.key === 'Escape') close(); };
      document.addEventListener('keydown', onKeyDown);

      closeBtn.addEventListener('click', close);

      submitBtn.onclick = async () => {
        const description = reason.value.trim();
        if (!description) return alert('กรุณากรอกเหตุผล');

        // ตัดสินใจเลือก endpoint ตาม type
        let url = '';
        if (type === 'post') {
          url = `/reports/post/${targetId}`;
        } else if (type === 'comment') {
          url = `/reports/comment/${targetId}`;
        } else {
          alert('ประเภทการรายงานไม่ถูกต้อง');
          return;
        }

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              [type === 'post' ? 'postId' : 'commentId']: targetId,
              description
            }),
            credentials: 'include'
          });

          const result = await response.json();

          if (!response.ok) {
            alert(result.error || 'ไม่สามารถส่งรายงานได้');
            return;
          }

          alert(result.message || 'รายงานถูกส่งเรียบร้อยแล้ว');
          close();
          reason.value = ''; // เคลียร์ข้อความ
        } catch (err) {
          console.error('Report request error:', err);
          alert('เกิดข้อผิดพลาดในการส่งรายงาน');
        }
      };
    }


    // อ่าน cookie user (สำหรับ fallback)
    function readCookie(name) {
      const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return m ? decodeURIComponent(m.pop()) : null;
    }

    function getPostId() {
      const p = new URLSearchParams(window.location.search);
      return p.get('id');
    }

    async function isOwner(postId) {
      try {
        const res = await fetch(`/posts/${postId}/owner`, { credentials: 'include' });
        if (res.ok) {
          const json = await res.json();
          return json.isOwner;
        }
      } catch { }
      // fallback เช็คจาก cookie + data-post-user-id ถ้ามี
      try {
        const user = JSON.parse(readCookie('user') || '{}');
        const ownerId = document.body?.dataset?.postUserId;
        if (user?.id && ownerId) return String(user.id) === String(ownerId);
      } catch { }
      return false;
    }

    async function injectEditButton() {
      const postId = getPostId();
      if (!postId) return;

      const owner = await isOwner(postId);
      console.log("owner", owner)
      if (owner == false) {
        console.log(owner)
        return;
      }

      const reportBtn = document.querySelector('.report-btn');
      if (!reportBtn || document.querySelector('.edit-post-btn')) return;
      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'edit-post-btn';
      editBtn.textContent = 'แก้ไขโพส';
      editBtn.addEventListener('click', () => {
        window.location.href = `/edit_post?id=${postId}`;
      });

      // ใส่ปุ่มไว้ด้านซ้ายของปุ่มรายงาน (ติดกัน)
      reportBtn.parentElement?.insertBefore(editBtn, reportBtn);
    }

    // โหลดข้อมูลจริง
    (async () => {
      hydrateSidebarProfile();
      fetchCategories();
      const postId = getPostId();
      if (!postId) {
        document.getElementById('post-box').innerHTML = '<p>ไม่พบโพสต์นี้</p>';
        return;
      }
      const [data, cmts] = await Promise.all([fetchPostDetail(postId), fetchComments(postId)]);
      currentPostData = data;
      renderPostDetail(data, cmts);
      injectEditButton();
    })();

    // แก้ไขฟังก์ชันแก้ไขโพสต์
    window.editPost = function (postId) {
      // ปิดเมนู
      document.getElementById(`post-menu-${postId}`).style.display = 'none';

      // ไปหน้าแก้ไขโพสต์
      window.location.href = `/posts/edit_post?id=${postId}`;
    };
  </script>
</body>

</html>